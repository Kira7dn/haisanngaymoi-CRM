# Enhanced Social OAuth Configuration Flow - Implementation Plan

## =� Overview

M�c ti�u: Sau khi user ho�n t�t OAuth, hi�n th� dialog h��ng d�n c�u h�nh webhook th� c�ng v� l�u th�ng tin platform-specific (App ID, OA ID, Client Key, etc.) v�o database.

## <� User Flow

```
1. User clicks "Connect" on /crm/social/connections
2. OAuth flow completes � Redirect back v�i success
3. ( NEW: Dialog popup v�i 2 tabs:
   - Tab 1: "Platform Settings" - Form nh�p App ID, secrets, etc.
   - Tab 2: "Webhook Setup" - H��ng d�n c�u h�nh webhook
4. User i�n th�ng tin � Save
5. Database c�p nh�t v�i platform config
6. Success message & close dialog
```

---

## =� Todo List

### 1. **Extend Database Schema for Platform Configuration**
- [ ] 1.1. Update `SocialAuth` domain entity
  - Add optional fields for platform-specific config
  - Maintain backward compatibility
- [ ] 1.2. Update `SocialAuthService` interface
  - Add methods for updating platform config
- [ ] 1.3. Update `SocialAuthRepository`
  - Implement config update methods
- [ ] 1.4. Test schema changes

### 2. **Create Platform Configuration API**
- [ ] 2.1. Create `/api/social-auth/config/route.ts`
  - POST endpoint to save platform config
  - Validation for platform-specific fields
- [ ] 2.2. Create use case `UpdatePlatformConfigUseCase`
  - Business logic for config updates
  - Validation rules
- [ ] 2.3. Add to depends.ts
- [ ] 2.4. Test API endpoint

### 3. **Build Configuration Dialog UI**
- [ ] 3.1. Create `ConfigurationDialog` component
  - Tabs: Settings & Webhook Guide
  - Platform-specific forms
- [ ] 3.2. Create `PlatformSettingsForm` component
  - Dynamic fields based on platform
  - Validation
- [ ] 3.3. Create `WebhookGuidePanel` component
  - Step-by-step instructions
  - Copy-to-clipboard for webhook URL
  - Platform-specific screenshots/links
- [ ] 3.4. Test dialog flow

### 4. **Integrate Dialog into Connection Flow**
- [ ] 4.1. Update `SocialConnectionsManager.tsx`
  - Detect successful OAuth callback
  - Show dialog automatically
- [ ] 4.2. Handle dialog state management
- [ ] 4.3. Handle form submission
- [ ] 4.4. Test complete flow

### 5. **Add Manual Configuration Trigger**
- [ ] 5.1. Add "Settings" button to connected platforms
- [ ] 5.2. Allow re-opening configuration dialog
- [ ] 5.3. Pre-fill existing config values
- [ ] 5.4. Test edit flow

### 6. **Testing & Documentation**
- [ ] 6.1. Test all platforms (Zalo, TikTok, Facebook)
- [ ] 6.2. Test error handling
- [ ] 6.3. Update user documentation
- [ ] 6.4. Add inline help text

---

## =� Database Schema Extension

### Extended `social_auth` Collection

```typescript
// core/domain/social/social-auth.ts

export interface PlatformConfig {
  // Common fields
  webhookUrl?: string

  // Zalo-specific
  zalo?: {
    appId: string
    appSecret: string
    oaId: string
  }

  // TikTok-specific
  tiktok?: {
    clientKey: string
    clientSecret: string
  }

  // Facebook-specific
  facebook?: {
    appId: string
    appSecret: string
    pageId: string
    verifyToken?: string
  }

  // YouTube-specific (future)
  youtube?: {
    clientId: string
    clientSecret: string
  }
}

export class SocialAuth {
  constructor(
    public readonly id: ObjectId = new ObjectId(),
    public platform: Platform,
    public openId: string,
    public pageName: string,
    public accessToken: string,
    public refreshToken: string,
    public expiresAt: Date,
    public userId: ObjectId,
    public scope?: string,
    public platformConfig?: PlatformConfig, // ( NEW FIELD
    public readonly createdAt: Date = new Date(),
    public updatedAt: Date = new Date()
  ) { }
}
```

---

## <� UI Components

### 1. Configuration Dialog Component

```typescript
// app/(features)/crm/social/connections/_components/ConfigurationDialog.tsx
"use client"

import { useState } from "react"
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@shared/ui/dialog"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@shared/ui/tabs"
import { Button } from "@shared/ui/button"
import { Loader2 } from "lucide-react"
import type { Platform } from "@/core/domain/social/social-auth"
import PlatformSettingsForm from "./PlatformSettingsForm"
import WebhookGuidePanel from "./WebhookGuidePanel"

interface ConfigurationDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  platform: Platform
  connectionId: string
  existingConfig?: any
}

export default function ConfigurationDialog({
  open,
  onOpenChange,
  platform,
  connectionId,
  existingConfig,
}: ConfigurationDialogProps) {
  const [activeTab, setActiveTab] = useState("settings")
  const [loading, setLoading] = useState(false)
  const [config, setConfig] = useState(existingConfig || {})

  const handleSave = async () => {
    setLoading(true)
    try {
      const response = await fetch("/api/social-auth/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          connectionId,
          platform,
          platformConfig: config,
        }),
      })

      if (!response.ok) {
        const data = await response.json()
        throw new Error(data.error || "Failed to save configuration")
      }

      // Success
      onOpenChange(false)
      window.location.reload() // Refresh to show updated config
    } catch (error) {
      alert(error instanceof Error ? error.message : "Failed to save")
    } finally {
      setLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-2xl">
            Configure {platform.charAt(0).toUpperCase() + platform.slice(1)}
          </DialogTitle>
        </DialogHeader>

        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList className="grid w-full grid-cols-2">
            <TabsTrigger value="settings">Platform Settings</TabsTrigger>
            <TabsTrigger value="webhook">Webhook Setup</TabsTrigger>
          </TabsList>

          <TabsContent value="settings" className="space-y-4 mt-4">
            <PlatformSettingsForm
              platform={platform}
              config={config}
              onChange={setConfig}
            />
          </TabsContent>

          <TabsContent value="webhook" className="space-y-4 mt-4">
            <WebhookGuidePanel platform={platform} />
          </TabsContent>
        </Tabs>

        <div className="flex justify-end gap-2 mt-6 pt-4 border-t">
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={loading}
          >
            Cancel
          </Button>
          <Button onClick={handleSave} disabled={loading}>
            {loading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            Save Configuration
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

---

### 2. Platform Settings Form

```typescript
// app/(features)/crm/social/connections/_components/PlatformSettingsForm.tsx
"use client"

import { Input } from "@shared/ui/input"
import { Label } from "@shared/ui/label"
import { Alert, AlertDescription } from "@shared/ui/alert"
import { InfoIcon } from "lucide-react"
import type { Platform } from "@/core/domain/social/social-auth"

interface PlatformSettingsFormProps {
  platform: Platform
  config: any
  onChange: (config: any) => void
}

export default function PlatformSettingsForm({
  platform,
  config,
  onChange,
}: PlatformSettingsFormProps) {
  const updateField = (platform: string, field: string, value: string) => {
    onChange({
      ...config,
      [platform]: {
        ...(config[platform] || {}),
        [field]: value,
      },
    })
  }

  const renderZaloFields = () => (
    <div className="space-y-4">
      <Alert>
        <InfoIcon className="h-4 w-4" />
        <AlertDescription>
          Get these credentials from{" "}
          <a
            href="https://developers.zalo.me"
            target="_blank"
            rel="noopener noreferrer"
            className="text-blue-600 hover:underline"
          >
            Zalo Developer Portal
          </a>
        </AlertDescription>
      </Alert>

      <div className="space-y-2">
        <Label htmlFor="zalo-app-id">App ID *</Label>
        <Input
          id="zalo-app-id"
          placeholder="Enter your Zalo App ID"
          value={config.zalo?.appId || ""}
          onChange={(e) => updateField("zalo", "appId", e.target.value)}
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="zalo-app-secret">App Secret *</Label>
        <Input
          id="zalo-app-secret"
          type="password"
          placeholder="Enter your Zalo App Secret"
          value={config.zalo?.appSecret || ""}
          onChange={(e) => updateField("zalo", "appSecret", e.target.value)}
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="zalo-oa-id">Official Account ID (OA ID) *</Label>
        <Input
          id="zalo-oa-id"
          placeholder="Enter your Zalo OA ID"
          value={config.zalo?.oaId || ""}
          onChange={(e) => updateField("zalo", "oaId", e.target.value)}
          required
        />
      </div>
    </div>
  )

  const renderTikTokFields = () => (
    <div className="space-y-4">
      <Alert>
        <InfoIcon className="h-4 w-4" />
        <AlertDescription>
          Get these credentials from{" "}
          <a
            href="https://developers.tiktok.com"
            target="_blank"
            rel="noopener noreferrer"
            className="text-blue-600 hover:underline"
          >
            TikTok Developer Portal
          </a>
        </AlertDescription>
      </Alert>

      <div className="space-y-2">
        <Label htmlFor="tiktok-client-key">Client Key *</Label>
        <Input
          id="tiktok-client-key"
          placeholder="Enter your TikTok Client Key"
          value={config.tiktok?.clientKey || ""}
          onChange={(e) => updateField("tiktok", "clientKey", e.target.value)}
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="tiktok-client-secret">Client Secret *</Label>
        <Input
          id="tiktok-client-secret"
          type="password"
          placeholder="Enter your TikTok Client Secret"
          value={config.tiktok?.clientSecret || ""}
          onChange={(e) => updateField("tiktok", "clientSecret", e.target.value)}
          required
        />
      </div>
    </div>
  )

  const renderFacebookFields = () => (
    <div className="space-y-4">
      <Alert>
        <InfoIcon className="h-4 w-4" />
        <AlertDescription>
          Get these credentials from{" "}
          <a
            href="https://developers.facebook.com"
            target="_blank"
            rel="noopener noreferrer"
            className="text-blue-600 hover:underline"
          >
            Facebook Developer Portal
          </a>
        </AlertDescription>
      </Alert>

      <div className="space-y-2">
        <Label htmlFor="fb-app-id">App ID *</Label>
        <Input
          id="fb-app-id"
          placeholder="Enter your Facebook App ID"
          value={config.facebook?.appId || ""}
          onChange={(e) => updateField("facebook", "appId", e.target.value)}
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="fb-app-secret">App Secret *</Label>
        <Input
          id="fb-app-secret"
          type="password"
          placeholder="Enter your Facebook App Secret"
          value={config.facebook?.appSecret || ""}
          onChange={(e) => updateField("facebook", "appSecret", e.target.value)}
          required
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="fb-page-id">Page ID</Label>
        <Input
          id="fb-page-id"
          placeholder="Your Facebook Page ID (auto-filled from OAuth)"
          value={config.facebook?.pageId || ""}
          onChange={(e) => updateField("facebook", "pageId", e.target.value)}
          disabled
        />
      </div>

      <div className="space-y-2">
        <Label htmlFor="fb-verify-token">Webhook Verify Token (Optional)</Label>
        <Input
          id="fb-verify-token"
          placeholder="Custom verify token for webhook verification"
          value={config.facebook?.verifyToken || ""}
          onChange={(e) => updateField("facebook", "verifyToken", e.target.value)}
        />
        <p className="text-xs text-gray-500">
          Leave empty to use default. Used during webhook setup.
        </p>
      </div>
    </div>
  )

  return (
    <div className="space-y-6">
      {platform === "zalo" && renderZaloFields()}
      {platform === "tiktok" && renderTikTokFields()}
      {platform === "facebook" && renderFacebookFields()}
      {platform === "youtube" && (
        <Alert>
          <AlertDescription>
            YouTube configuration coming soon...
          </AlertDescription>
        </Alert>
      )}
    </div>
  )
}
```

---

### 3. Webhook Guide Panel

```typescript
// app/(features)/crm/social/connections/_components/WebhookGuidePanel.tsx
"use client"

import { useState } from "react"
import { Button } from "@shared/ui/button"
import { Alert, AlertDescription } from "@shared/ui/alert"
import { CheckCircle2, Copy, ExternalLink } from "lucide-react"
import type { Platform } from "@/core/domain/social/social-auth"

interface WebhookGuidePanelProps {
  platform: Platform
}

export default function WebhookGuidePanel({ platform }: WebhookGuidePanelProps) {
  const [copied, setCopied] = useState(false)

  const webhookUrl = `${window.location.origin}/api/webhooks/${platform}`

  const copyToClipboard = () => {
    navigator.clipboard.writeText(webhookUrl)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
  }

  const renderZaloGuide = () => (
    <div className="space-y-4">
      <Alert className="bg-blue-50 dark:bg-blue-900/20 border-blue-200">
        <AlertDescription>
          <strong>Note:</strong> Zalo webhook is configured through the Zalo Developer Portal,
          not programmatically.
        </AlertDescription>
      </Alert>

      <div className="space-y-3">
        <h3 className="font-semibold">Step-by-Step Guide:</h3>

        <ol className="space-y-3 list-decimal list-inside">
          <li>
            Go to{" "}
            <a
              href="https://developers.zalo.me"
              target="_blank"
              rel="noopener noreferrer"
              className="text-blue-600 hover:underline inline-flex items-center gap-1"
            >
              Zalo Developer Portal
              <ExternalLink className="h-3 w-3" />
            </a>
          </li>

          <li>Select your Official Account (OA) application</li>

          <li>Navigate to <strong>Webhook Settings</strong> or <strong>C�i �t Webhook</strong></li>

          <li>
            Enter your webhook URL:
            <div className="flex items-center gap-2 mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-md font-mono text-sm">
              <code className="flex-1">{webhookUrl}</code>
              <Button
                size="sm"
                variant="ghost"
                onClick={copyToClipboard}
                className="shrink-0"
              >
                {copied ? (
                  <CheckCircle2 className="h-4 w-4 text-green-600" />
                ) : (
                  <Copy className="h-4 w-4" />
                )}
              </Button>
            </div>
          </li>

          <li>Zalo will send a verification request to your webhook URL</li>

          <li>
            After successful verification, enable these event subscriptions:
            <ul className="list-disc list-inside ml-6 mt-2 space-y-1 text-sm">
              <li><code>user_send_text</code> - Text messages</li>
              <li><code>user_send_image</code> - Image messages</li>
              <li><code>user_send_file</code> - File attachments</li>
              <li><code>user_send_audio</code> - Audio messages</li>
              <li><code>user_send_video</code> - Video messages</li>
            </ul>
          </li>

          <li>Save your webhook configuration</li>
        </ol>
      </div>

      <Alert>
        <AlertDescription>
          =� <strong>Tip:</strong> Make sure your webhook URL is publicly accessible.
          Use ngrok for local development.
        </AlertDescription>
      </Alert>
    </div>
  )

  const renderTikTokGuide = () => (
    <div className="space-y-4">
      <Alert className="bg-blue-50 dark:bg-blue-900/20 border-blue-200">
        <AlertDescription>
          <strong>Note:</strong> TikTok webhook is configured through the Developer Portal.
        </AlertDescription>
      </Alert>

      <div className="space-y-3">
        <h3 className="font-semibold">Step-by-Step Guide:</h3>

        <ol className="space-y-3 list-decimal list-inside">
          <li>
            Go to{" "}
            <a
              href="https://developers.tiktok.com"
              target="_blank"
              rel="noopener noreferrer"
              className="text-blue-600 hover:underline inline-flex items-center gap-1"
            >
              TikTok Developer Portal
              <ExternalLink className="h-3 w-3" />
            </a>
          </li>

          <li>Select your application</li>

          <li>Go to <strong>Webhook Settings</strong></li>

          <li>
            Register your callback URL:
            <div className="flex items-center gap-2 mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-md font-mono text-sm">
              <code className="flex-1">{webhookUrl}</code>
              <Button
                size="sm"
                variant="ghost"
                onClick={copyToClipboard}
                className="shrink-0"
              >
                {copied ? (
                  <CheckCircle2 className="h-4 w-4 text-green-600" />
                ) : (
                  <Copy className="h-4 w-4" />
                )}
              </Button>
            </div>
          </li>

          <li>
            Your endpoint must:
            <ul className="list-disc list-inside ml-6 mt-2 space-y-1 text-sm">
              <li>Use HTTPS (not HTTP)</li>
              <li>Respond with 200 status code immediately</li>
              <li>Handle GET request with <code>challenge</code> parameter for verification</li>
            </ul>
          </li>

          <li>TikTok will verify your webhook by sending a GET request</li>

          <li>After verification, you'll start receiving POST requests for events</li>
        </ol>
      </div>

      <Alert>
        <AlertDescription>
          =� <strong>Tip:</strong> TikTok retries failed deliveries for up to 72 hours using exponential backoff.
        </AlertDescription>
      </Alert>
    </div>
  )

  const renderFacebookGuide = () => (
    <div className="space-y-4">
      <Alert className="bg-green-50 dark:bg-green-900/20 border-green-200">
        <AlertDescription>
          <strong>Good news!</strong> Facebook webhook subscription is handled automatically
          when you select a page.
        </AlertDescription>
      </Alert>

      <div className="space-y-3">
        <h3 className="font-semibold">What happens automatically:</h3>

        <ul className="space-y-2 list-disc list-inside">
          <li>
            When you select a Facebook Page during OAuth, the system automatically subscribes
            to webhook events:
            <ul className="list-disc list-inside ml-6 mt-2 space-y-1 text-sm">
              <li><code>messages</code> - Incoming messages</li>
              <li><code>messaging_postbacks</code> - Button clicks and interactions</li>
            </ul>
          </li>
        </ul>

        <h3 className="font-semibold mt-6">Manual verification (if needed):</h3>

        <ol className="space-y-3 list-decimal list-inside">
          <li>
            Go to{" "}
            <a
              href="https://developers.facebook.com"
              target="_blank"
              rel="noopener noreferrer"
              className="text-blue-600 hover:underline inline-flex items-center gap-1"
            >
              Facebook Developer Portal
              <ExternalLink className="h-3 w-3" />
            </a>
          </li>

          <li>Select your app � Webhooks</li>

          <li>
            Verify webhook URL is set to:
            <div className="flex items-center gap-2 mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-md font-mono text-sm">
              <code className="flex-1">{webhookUrl}</code>
              <Button
                size="sm"
                variant="ghost"
                onClick={copyToClipboard}
                className="shrink-0"
              >
                {copied ? (
                  <CheckCircle2 className="h-4 w-4 text-green-600" />
                ) : (
                  <Copy className="h-4 w-4" />
                )}
              </Button>
            </div>
          </li>

          <li>Check that your Page is subscribed to webhook events</li>
        </ol>
      </div>
    </div>
  )

  return (
    <div className="space-y-6">
      {platform === "zalo" && renderZaloGuide()}
      {platform === "tiktok" && renderTikTokGuide()}
      {platform === "facebook" && renderFacebookGuide()}
      {platform === "youtube" && (
        <Alert>
          <AlertDescription>
            YouTube webhook guide coming soon...
          </AlertDescription>
        </Alert>
      )}
    </div>
  )
}
```

---

## =' Backend Implementation

### 1. Update Use Case

```typescript
// core/application/usecases/social/update-platform-config.ts

import type { SocialAuthService } from "@/core/application/interfaces/social/social-auth-service"
import type { PlatformConfig } from "@/core/domain/social/social-auth"
import { ObjectId } from "mongodb"

export interface UpdatePlatformConfigRequest {
  connectionId: string
  platformConfig: PlatformConfig
}

export interface UpdatePlatformConfigResponse {
  success: boolean
  message?: string
}

export class UpdatePlatformConfigUseCase {
  constructor(private socialAuthService: SocialAuthService) {}

  async execute(
    request: UpdatePlatformConfigRequest
  ): Promise<UpdatePlatformConfigResponse> {
    try {
      const { connectionId, platformConfig } = request

      // Validate connectionId
      if (!ObjectId.isValid(connectionId)) {
        return {
          success: false,
          message: "Invalid connection ID",
        }
      }

      // Update the social auth record
      const updated = await this.socialAuthService.update({
        id: new ObjectId(connectionId),
        platformConfig,
      })

      if (!updated) {
        return {
          success: false,
          message: "Connection not found",
        }
      }

      return {
        success: true,
        message: "Platform configuration updated successfully",
      }
    } catch (error) {
      console.error("UpdatePlatformConfigUseCase error:", error)
      return {
        success: false,
        message: error instanceof Error ? error.message : "Unknown error",
      }
    }
  }
}
```

---

### 2. API Route

```typescript
// app/api/social-auth/config/route.ts

import { NextRequest, NextResponse } from "next/server"
import { cookies } from "next/headers"
import { createUpdatePlatformConfigUseCase } from "./depends"

export async function POST(request: NextRequest) {
  try {
    // Verify user is authenticated
    const cookieStore = await cookies()
    const userIdCookie = cookieStore.get("admin_user_id")

    if (!userIdCookie) {
      return NextResponse.json(
        { error: "Unauthorized - Please login first" },
        { status: 401 }
      )
    }

    const body = await request.json()
    const { connectionId, platform, platformConfig } = body

    if (!connectionId || !platform || !platformConfig) {
      return NextResponse.json(
        { error: "Missing required fields: connectionId, platform, platformConfig" },
        { status: 400 }
      )
    }

    // Execute use case
    const useCase = await createUpdatePlatformConfigUseCase()
    const result = await useCase.execute({
      connectionId,
      platformConfig,
    })

    if (!result.success) {
      return NextResponse.json(
        { error: result.message || "Failed to update configuration" },
        { status: 500 }
      )
    }

    return NextResponse.json({
      success: true,
      message: result.message || "Configuration updated successfully",
    })
  } catch (error) {
    console.error("Error updating platform config:", error)
    return NextResponse.json(
      { error: error instanceof Error ? error.message : "Failed to update configuration" },
      { status: 500 }
    )
  }
}
```

---

### 3. Depends Factory

```typescript
// app/api/social-auth/config/depends.ts

import { SocialAuthRepository } from "@/infrastructure/repositories/social/social-auth-repo"
import { UpdatePlatformConfigUseCase } from "@/core/application/usecases/social/update-platform-config"

export const createUpdatePlatformConfigUseCase = async () => {
  const socialAuthService = new SocialAuthRepository()
  return new UpdatePlatformConfigUseCase(socialAuthService)
}
```

---

## = Integration with Existing Flow

### Update `SocialConnectionsManager.tsx`

```typescript
// Add to existing component

const [showConfigDialog, setShowConfigDialog] = useState(false)
const [configPlatform, setConfigPlatform] = useState<Platform | null>(null)
const [configConnectionId, setConfigConnectionId] = useState<string | null>(null)

// Modify useEffect to show dialog after OAuth success
useEffect(() => {
  const success = searchParams.get("success")
  const error = searchParams.get("error")
  const platform = searchParams.get("platform") as Platform | null

  if (success === "true" && platform) {
    setMessage({
      type: "success",
      text: `${platform.charAt(0).toUpperCase() + platform.slice(1)} account connected successfully!`,
    })

    // ( NEW: Show configuration dialog
    const connection = connections.find(c => c.platform === platform)
    if (connection) {
      setConfigPlatform(platform)
      setConfigConnectionId(connection.id)
      setShowConfigDialog(true)
    }

    router.refresh()
    router.replace("/crm/social/connections")
  } else if (error) {
    setMessage({
      type: "error",
      text: `Failed to connect: ${decodeURIComponent(error)}`,
    })
  }
}, [searchParams, router, connections])

// Add "Settings" button to connected platforms
{isConnected && connection ? (
  <div className="space-y-3">
    {/* ... existing code ... */}

    <div className="flex gap-2">
      <Button
        variant="outline"
        size="sm"
        onClick={() => {
          setConfigPlatform(platform.id)
          setConfigConnectionId(connection.id)
          setShowConfigDialog(true)
        }}
        className="flex-1"
      >
        Settings
      </Button>
      {/* ... other buttons ... */}
    </div>
  </div>
) : null}

// Add dialog at the end of component
return (
  <div className="space-y-4">
    {/* ... existing UI ... */}

    {/* Configuration Dialog */}
    {showConfigDialog && configPlatform && configConnectionId && (
      <ConfigurationDialog
        open={showConfigDialog}
        onOpenChange={setShowConfigDialog}
        platform={configPlatform}
        connectionId={configConnectionId}
        existingConfig={
          connections.find(c => c.id === configConnectionId)?.platformConfig
        }
      />
    )}
  </div>
)
```

---

##  Testing Checklist

### Unit Tests
- [ ] Test `UpdatePlatformConfigUseCase`
- [ ] Test API route with valid/invalid data
- [ ] Test form validation

### Integration Tests
- [ ] Test complete OAuth � Dialog � Save flow for Zalo
- [ ] Test complete OAuth � Dialog � Save flow for TikTok
- [ ] Test complete OAuth � Dialog � Save flow for Facebook
- [ ] Test reopening settings for existing connections
- [ ] Test error handling (network failures, validation errors)

### Manual Tests
- [ ] Verify dialog opens after OAuth success
- [ ] Verify all form fields render correctly
- [ ] Verify webhook URLs are correct
- [ ] Verify copy-to-clipboard works
- [ ] Verify external links open correctly
- [ ] Test on mobile responsive design

---

## =� Documentation Updates

### User Guide Section to Add

```markdown
# Configuring Social Media Webhooks

After connecting your social media account, you'll need to complete the webhook setup:

## Zalo Official Account

1. After OAuth, a configuration dialog will appear
2. Fill in your App ID, App Secret, and OA ID from Zalo Developer Portal
3. Switch to "Webhook Setup" tab
4. Copy the webhook URL
5. Go to Zalo Developer Portal and configure the webhook
6. Enable event subscriptions for messages
7. Save both platform settings and Zalo webhook configuration

## TikTok

1. After OAuth, a configuration dialog will appear
2. Fill in your Client Key and Client Secret
3. Switch to "Webhook Setup" tab
4. Copy the callback URL
5. Go to TikTok Developer Portal � Webhooks
6. Register the callback URL
7. Save your configuration

## Facebook

Facebook webhook subscription is automatic! When you select a Page during
OAuth, the system automatically subscribes to message events.

You can verify this in Facebook Developer Portal � Webhooks.
```

---

## <� Success Criteria

1.  Dialog appears automatically after OAuth success
2.  All platform-specific fields render correctly
3.  Webhook guide is clear and helpful
4.  Copy-to-clipboard works smoothly
5.  Configuration saves to database correctly
6.  "Settings" button allows editing existing config
7.  No breaking changes to existing OAuth flow
8.  Mobile-responsive design
9.  Error handling is user-friendly
10.  Documentation is updated

---

## =� Deployment Notes

1. Run database migration (schema is backward compatible)
2. Deploy backend changes first (API routes + use cases)
3. Deploy frontend changes (UI components)
4. Test on staging environment
5. Update user documentation
6. Communicate changes to users

---

## =� Estimated Effort

- **Backend (Domain, Use Case, API)**: 3-4 hours
- **UI Components (Dialog, Forms, Guide)**: 4-5 hours
- **Integration & Testing**: 2-3 hours
- **Documentation**: 1 hour

**Total**: ~10-13 hours

---

## =. Future Enhancements

1. Add validation for webhook URL reachability
2. Add webhook test button (send test event)
3. Add webhook event logs viewer
4. Add platform health status indicators
5. Add bulk configuration for multiple accounts
6. Add configuration export/import
7. Add webhook retry configuration

---

**End of Implementation Plan**
